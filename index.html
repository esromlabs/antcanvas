<!DOCTYPE HTML>
<html>
  <head>
    <title>Ant Canvas</title>
    <style>
      button.running {
        color: #FF0000;
      }
      button.stopped {
        color: #000000;
      }
    </style>
    <script type="text/javascript" src="js/graphlet/graphlet_query.js"></script>
    <script type="text/javascript" src="js/graphlet/graphlet_procedural_run.js"></script>
  </head>
  <body>
    <canvas id="theCanvas" width="578" height="200"></canvas>
    <button id="toggle">toggle run</button>
    <script>
      var graph = {"graph":{"name":"Loop 1","template":"<button id='start_button'>Start</button><div class='counter'></div>"}, "nodes":[
  {"id":"n4","data":{"c":0},"name":"c"},
  {"id":"n3","name":"c","io":{"selector":".counter"},"data":{"c":0}},
  {"name":"fin","id":"n5","data":{"c":0}},
  {"name":"c+=1","process":["this.c = c + 1;"],"id":"n1"},
  {"name":"start","id":"n0","io":{"selector":"#start_button"}}
 ],
 "edges":[
  ["n1","n5","flo","","",0],
  ["n1","n3","set","","",1],
  ["n0","n4","sub","click","",2],
  ["n4","n1","flo","","",3],
  ["n1","n3","get","","",4],
  ["n4","n3","set","","",5],
  ["n1","n1","flo","","c <=5",6]
 ]};
      var graphlet = init_graphlet(graph);
      var x = 100, y = 50;
      var g_run = false;
      var g_step_on_toes = 500;
      window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame ||
          window.oRequestAnimationFrame ||
          window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();
      function animate(canvas, cx) {
        graphlet.run_node();
        var dx;
        var dy;

        dx = Math.floor( Math.random()*3)-1;
        dy = Math.floor( Math.random()*3)-1;
        x += dx;
        y += dy;
        if (isSteppedOn(x, y)) {
          g_step_on_toes -= 1;
          if ((g_step_on_toes > 0) !== g_run) {
            set_run((g_step_on_toes > 0));
          }
        }
        setPixel(x, y, [0,0,0,255]);

        // request new frame
        if (g_run) {
          requestAnimFrame(function() {
            animate(canvas, cx);
          });
        }
      }

      function setPixel(x, y, color) {
        // write a pixel
        d[0]   = color[0];
        d[1]   = color[1];
        d[2]   = color[2];
        d[3]   = color[3];
        cx.putImageData(id, x, y);
      }
      function isSteppedOn(x, y) {
        var p = cx.getImageData(x, y, 1, 1).data;
        if (p[0] < 10 && p[1] < 10 && p[2] < 10 && p[3] > 200) {
          return true;
        }
        return false;
      }
      var canvas = document.getElementById('theCanvas');
      var cx = canvas.getContext('2d');
      // create a one pixel image to be used to paint one pixel
      var id = cx.createImageData(1,1); // only do this once per page
      var d  = id.data;
      var p;

      // init the entire canvas to white
      cx.fillStyle = "#FFFFFF";
      cx.fillRect(0, 0, canvas.width, canvas.height);

      //animate(canvas, cx);

      // bind event handler to clear button
      document.getElementById('toggle').addEventListener('click', function() {
        set_run(!g_run);
        if (g_run) {
          // clear
          x = 100;
          y = 50;
          g_step_on_toes = 500;
          cx.fillStyle = "#FFFFFF";
          cx.clearRect(0, 0, canvas.width, canvas.height);
          animate(canvas, cx);
        }
      }, false);
      function set_run (new_run) {
        var class_name = (new_run)? "running": "stopped";
        document.getElementById('toggle').setAttribute("class", class_name);
        g_run = new_run;
      }


    </script>
  </body>
</html>
